# docker-compose.test.yml
#
# Full-stack integration test environment for ACARS Hub.
#
# Architecture:
#   db-init    — copies the committed seed database + RRD fixture to a named
#                volume before the backend starts, ensuring a clean known state
#                on every run.
#   backend    — the production `ah:test` Docker image (Node.js backend + nginx
#                + React frontend) started with all decoders disabled and the
#                seed database mounted.
#   playwright — official Playwright Docker image; waits for the backend
#                healthcheck to pass, then runs the integration E2E suite.
#
# Usage:
#   just build-test-image          # build ah:test from Node.Dockerfile
#   just test-e2e-fullstack        # runs this compose file end-to-end
#
# The justfile target calls `down --volumes` after the run, so named volumes
# are always wiped between runs and every execution starts from the committed
# seed.db.

services:
  # ── db-init ────────────────────────────────────────────────────────────────
  # One-shot init container: copies the seed DB and RRD fixture into the shared
  # named volume so the backend always starts with a clean, reproducible state.
  # Also creates the `.back` sentinel file that tells the Node.js backend that
  # the RRD → SQLite migration has already been applied (the seed.db already
  # contains the pre-migrated timeseries_stats rows).
  db-init:
    image: alpine:3
    volumes:
      - ./test-fixtures:/src:ro
      - acarshub-test-db:/run/acars
    command:
      - sh
      - -c
      - |
        cp /src/seed.db /run/acars/messages.db
        cp /src/test.rrd /run/acars/acarshub.rrd
        touch /run/acars/acarshub.rrd.back

  # ── backend ────────────────────────────────────────────────────────────────
  # Production Docker image running with the seed database.
  # All message decoders are disabled — there are no external TCP feeds in the
  # test environment. ENABLE_WEB=true keeps nginx + the Node.js backend running.
  backend:
    image: ah:test
    depends_on:
      db-init:
        condition: service_completed_successfully
    environment:
      # Point the backend at the seed database in the named volume
      - ACARSHUB_DB=/run/acars/messages.db
      # Disable all decoder TCP listeners (no external feeds in CI)
      - ENABLE_ACARS=false
      - ENABLE_VDLM=false
      - ENABLE_HFDL=false
      - ENABLE_IMSL=false
      - ENABLE_IRDM=false
      # Web server must stay enabled (serves React SPA + Socket.IO)
      - ENABLE_WEB=true
      # Disable ADS-B polling (no external URL available in CI)
      - ENABLE_ADSB=false
      # Reduce log verbosity in CI
      - MIN_LOG_LEVEL=3
      - QUIET_MESSAGES=true
      # Disable range rings (no ADS-B, so not needed)
      - ENABLE_RANGE_RINGS=false
    volumes:
      - acarshub-test-db:/run/acars
    tmpfs:
      - /var/log
      - /tmp
    # Health check targets the Node.js /health endpoint directly on port 8080.
    # This is more reliable than checking nginx on port 80 because it confirms
    # the backend is ready to accept Socket.IO connections before Playwright
    # starts loading the frontend.
    healthcheck:
      test:
        - CMD-SHELL
        - curl -sf http://localhost:8080/health || exit 1
      interval: 3s
      timeout: 5s
      retries: 25
      start_period: 30s
    # Expose port 80 on the host for ad-hoc manual inspection
    ports:
      - "3001:80"

  # ── playwright ─────────────────────────────────────────────────────────────
  # Official Playwright Docker image.  Waits for the backend healthcheck, then
  # runs only the integration E2E suite via the dedicated config file.
  #
  # Named volumes shadow the Nix-built host node_modules with Ubuntu-compatible
  # builds, identical to the `test-e2e-docker` justfile target.  Docker reuses
  # the volumes on subsequent runs so `npm ci` is fast after the first install.
  playwright:
    image: mcr.microsoft.com/playwright:v1.58.2-noble
    depends_on:
      backend:
        condition: service_healthy
    working_dir: /work
    volumes:
      - .:/work
      - acarshub-integration-root-modules:/work/node_modules
      - acarshub-integration-react-modules:/work/acarshub-react/node_modules
      - acarshub-integration-backend-modules:/work/acarshub-backend/node_modules
      - acarshub-integration-types-modules:/work/acarshub-types/node_modules
    environment:
      - CI=true
      # Tells playwright.integration.config.ts which project to use
      - PLAYWRIGHT_INTEGRATION=true
      # Backend is reachable at http://backend inside the compose network
      - INTEGRATION_BASE_URL=http://backend
    command: >
      bash -c "
        npm ci &&
        cd acarshub-react &&
        npx playwright test e2e/integration/
          --config playwright.integration.config.ts
          --reporter=line
      "

volumes:
  # Shared writable volume for the seed DB and RRD file (wiped by `down --volumes`)
  acarshub-test-db:
  # node_modules volumes (reused across runs for speed; wiped by `down --volumes`)
  acarshub-integration-root-modules:
  acarshub-integration-react-modules:
  acarshub-integration-backend-modules:
  acarshub-integration-types-modules:
