---
# GitHub Action: Update FIR Boundaries
#
# This workflow automatically monitors the vatsimnetwork/vatspy-data-project
# repository for new releases and creates a pull request when updated boundary
# data is available.
#
# What it does:
# 1. Checks the current FIR boundary version in acarshub-react/ATTRIBUTIONS.md
# 2. Queries the GitHub API for the latest vatspy-data-project release
# 3. If a new version is found:
#    - Downloads Boundaries.geojson from the release
#    - Renames it to FIRBoundaries.geojson
#    - Updates the version number in ATTRIBUTIONS.md
#    - Creates a pull request with the changes
# 4. If already up to date, exits without changes
#
# Schedule: Runs daily at 4 AM UTC
# Manual trigger: Available via workflow_dispatch
#
# Required secrets:
# - PAT: Personal Access Token with repo and pull_request permissions
#
# Files updated:
# - acarshub-react/public/geojson/FIRBoundaries.geojson
# - acarshub-react/ATTRIBUTIONS.md
#
# License: vatspy-data-project is licensed under CC BY-SA 4.0
# Source: https://github.com/vatsimnetwork/vatspy-data-project

name: Update FIR Boundaries

on:
  schedule:
    # Run daily at 4 AM UTC to check for new releases
    - cron: "0 4 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    name: Check for new vatspy-data-project release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: false
          ref: main

      - name: Get current FIR boundary version
        id: current-version
        run: |
          current_version=$(sed -n '/^### VATSpy Data Project/,/^##/p' acarshub-react/ATTRIBUTIONS.md | grep '\*\*Version\*\*:' | sed 's/^.*: //')
          echo "version=${current_version}" >> "$GITHUB_OUTPUT"
          echo "Current version: ${current_version}"

      - name: Get latest vatspy-data-project release
        id: latest-release
        run: |
          latest_tag=$(curl -s https://api.github.com/repos/vatsimnetwork/vatspy-data-project/releases/latest | jq -r '.tag_name')
          echo "tag=${latest_tag}" >> "$GITHUB_OUTPUT"
          echo "Latest release: ${latest_tag}"

      - name: Compare versions
        id: compare
        run: |
          current="${{ steps.current-version.outputs.version }}"
          latest="${{ steps.latest-release.outputs.tag }}"

          if [ "$current" = "$latest" ]; then
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            echo "No update needed - already at latest version: ${current}"
          else
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "Update needed - current: ${current}, latest: ${latest}"
          fi

      - name: Download new FIR boundary data
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          release_tag="${{ steps.latest-release.outputs.tag }}"
          base_url="https://github.com/vatsimnetwork/vatspy-data-project/releases/download/${release_tag}"

          echo "Downloading Boundaries.geojson..."
          curl -L -o acarshub-react/public/geojson/FIRBoundaries.geojson \
            "${base_url}/Boundaries.geojson"

          echo "Download complete"

      - name: Update ATTRIBUTIONS.md version
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          new_version="${{ steps.latest-release.outputs.tag }}"
          sed -i "/^### VATSpy Data Project/,/^##/{s/^\(- \*\*Version\*\*:\).*/\1 ${new_version}/}" acarshub-react/ATTRIBUTIONS.md
          echo "Updated ATTRIBUTIONS.md to version ${new_version}"

      - name: Configure Git identity
        if: steps.compare.outputs.needs_update == 'true'
        run: |
          git config --global user.email "noreply@github.com"
          git config --global user.name "github[bot]"

      - name: Create Pull Request
        if: steps.compare.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@c0f553fe549906ede9cf27b5156039d195d2ece0 # v8.1.0
        with:
          token: ${{ secrets.PAT }}
          commit-message: "chore: update FIR boundaries to ${{ steps.latest-release.outputs.tag }}"
          branch: update-fir-boundaries-${{ steps.latest-release.outputs.tag }}
          delete-branch: true
          title: "chore: update FIR boundaries to ${{ steps.latest-release.outputs.tag }}"
          body: |
            ## FIR Boundary Update

            This PR updates the VATSpy FIR boundary GeoJSON data to version **${{ steps.latest-release.outputs.tag }}**.

            ### Changes
            - ✅ Updated `FIRBoundaries.geojson` from vatspy-data-project release
            - ✅ Updated version in `ATTRIBUTIONS.md`

            ### Source
            - **Repository**: https://github.com/vatsimnetwork/vatspy-data-project
            - **Release**: https://github.com/vatsimnetwork/vatspy-data-project/releases/tag/${{ steps.latest-release.outputs.tag }}
            - **License**: CC BY-SA 4.0

            ### Testing Checklist
            - [ ] FIR boundaries render correctly on the live map
            - [ ] No console errors related to GeoJSON loading
            - [ ] Boundary polygons appear at expected locations
            - [ ] Hover popups show the correct FIR identifier and division
            - [ ] Mobile and desktop views both work

            ---

            *This PR was automatically created by the `update-fir-boundaries` GitHub Action.*
          labels: |
            dependencies
            automated
          draft: false

      - name: No update needed
        if: steps.compare.outputs.needs_update == 'false'
        run: |
          echo "✅ FIR boundaries are already up to date at version ${{ steps.current-version.outputs.version }}"
