# Python Dependency Management

## Overview

ACARSHUB uses two files to manage Python dependencies:

- **`pyproject.toml`**: Source of truth for PDM (used for local development)
- **`rootfs/webapp/requirements.txt`**: Used by Docker for production builds

Both files must be kept in sync manually using the provided tools.

---

## Quick Start

### Update Dependencies

```bash
# Update all Python packages to latest versions
just update-py

# Install dependencies after update
just bump-py

# Or do both at once
just update-all  # Updates Node.js AND Python
```

### Manual Sync

If you edit `pyproject.toml` manually:

```bash
./sync-python-deps.sh
```

This ensures `requirements.txt` matches `pyproject.toml`.

---

## How It Works

### The Sync Script

`sync-python-deps.sh` does the following:

1. **Exports** dependencies from `pyproject.toml` using `pdm export`
2. **Fixes** git-based dependencies (e.g., `rrdtool`)
3. **Verifies** version consistency between files
4. **Reports** any mismatches or issues

### Git-Based Dependencies

Git dependencies require special handling:

**pyproject.toml format:**
```toml
rrdtool @ git+https://github.com/fredclausen/python-rrdtool.git
```

**requirements.txt format:**
```txt
rrdtool @git+https://github.com/fredclausen/python-rrdtool.git@b522cab1db4039b21ef6e34e2221c2828ca72174
```

The sync script automatically:
- Extracts the commit hash from PDM's export
- Formats it correctly for Docker builds
- Preserves the git URL from `pyproject.toml`

---

## Common Tasks

### Add a New Dependency

```bash
# Add with PDM
pdm add package-name

# Or edit pyproject.toml directly, then:
pdm install

# Sync to requirements.txt
./sync-python-deps.sh
```

### Update a Single Package

```bash
# Update one package
pdm update package-name

# Sync to requirements.txt
./sync-python-deps.sh
```

### Update All Packages

```bash
# Update everything
just update-py

# This runs:
# 1. pdm update (updates all packages)
# 2. ./sync-python-deps.sh (syncs requirements.txt)
```

### Pin a Specific Version

**In pyproject.toml:**
```toml
dependencies = [
    "flask==3.1.2",  # Pinned to specific version
]
```

Then sync:
```bash
./sync-python-deps.sh
```

### Update Git-Based Dependencies

```bash
# Update to latest commit
pdm update rrdtool

# Or specify a commit/tag in pyproject.toml:
rrdtool @ git+https://github.com/fredclausen/python-rrdtool.git@v1.2.3

# Then sync
./sync-python-deps.sh
```

---

## Workflow Examples

### Development Workflow

```bash
# 1. Make changes to pyproject.toml
nano pyproject.toml

# 2. Install locally
pdm install

# 3. Sync to requirements.txt
./sync-python-deps.sh

# 4. Test locally
pdm run dev

# 5. Test in Docker
docker-compose build
docker-compose up
```

### Dependency Update Workflow

```bash
# 1. Update all packages
just update-py

# 2. Review changes
git diff pyproject.toml rootfs/webapp/requirements.txt

# 3. Test locally
pdm run dev

# 4. Test in Docker
docker-compose build
docker-compose up

# 5. Commit if all looks good
git add pyproject.toml rootfs/webapp/requirements.txt pdm.lock
git commit -m "chore: update Python dependencies"
```

---

## Understanding PDM

### What is PDM?

PDM (Python Development Master) is a modern Python package manager that:
- Uses PEP 582 (no need for virtualenv)
- Manages dependencies via `pyproject.toml`
- Creates lock files for reproducible builds (`pdm.lock`)

### Key Commands

```bash
# Install all dependencies
pdm install

# Add a package
pdm add package-name

# Add a dev dependency
pdm add -d package-name

# Update all packages
pdm update

# Update one package
pdm update package-name

# Show installed packages
pdm list

# Show outdated packages
pdm update --dry-run

# Export to requirements.txt
pdm export --without-hashes -o requirements.txt
```

---

## Files Explained

### pyproject.toml

```toml
[project]
name = "docker-acarshub"
version = "3.14.0"
dependencies = [
    "django==6.0.2",
    "Flask==3.1.2",
    # ... more packages
]
```

- **Source of truth** for development
- Used by PDM
- Contains all package metadata
- Version controlled

### requirements.txt

```txt
django==6.0.2
Flask==3.1.2
# ... more packages
```

- **Generated from pyproject.toml**
- Used by Docker
- Plain text format
- Compatible with `pip install -r`
- Version controlled

### pdm.lock

```toml
# Auto-generated lock file
[[package]]
name = "flask"
version = "3.1.2"
# ... dependency tree
```

- **Lock file** for reproducible builds
- Auto-generated by PDM
- Contains full dependency tree
- Version controlled
- DO NOT edit manually

---

## Troubleshooting

### Versions Don't Match

**Problem:** `pyproject.toml` and `requirements.txt` have different versions

**Solution:**
```bash
./sync-python-deps.sh
```

### Git Dependency Broken

**Problem:** Docker build fails with git dependency error

**Solution:**
```bash
# Re-sync with correct commit hash
./sync-python-deps.sh

# Or manually fix in requirements.txt:
rrdtool @git+https://github.com/fredclausen/python-rrdtool.git@<commit-hash>
```

### PDM Lock File Conflicts

**Problem:** Merge conflict in `pdm.lock`

**Solution:**
```bash
# Regenerate lock file
pdm lock --update-reuse

# Or from scratch
rm pdm.lock
pdm lock
```

### Package Not Installing

**Problem:** `pdm install` fails

**Solution:**
```bash
# Clear cache
pdm cache clear

# Try again
pdm install

# Or force reinstall
pdm install --no-lock
pdm lock
```

### Docker Build Uses Wrong Versions

**Problem:** Docker uses outdated packages

**Solution:**
```bash
# 1. Ensure requirements.txt is synced
./sync-python-deps.sh

# 2. Rebuild without cache
docker-compose build --no-cache

# 3. Verify versions in container
docker-compose run web pip list
```

---

## Best Practices

### 1. Always Sync After Changes

```bash
# Edit pyproject.toml
nano pyproject.toml

# ALWAYS sync
./sync-python-deps.sh
```

### 2. Pin Important Versions

```toml
# Pin packages with breaking changes
dependencies = [
    "sqlalchemy==2.0.46",  # Don't auto-update
    "alembic==1.18.3",     # Keep in sync with SQLAlchemy
]
```

### 3. Test Both Environments

```bash
# Test local (PDM)
pdm run dev

# Test Docker (requirements.txt)
docker-compose up
```

### 4. Review Updates Before Committing

```bash
# Check what changed
git diff pyproject.toml
git diff rootfs/webapp/requirements.txt

# Test thoroughly before committing
just ci
```

### 5. Keep Lock File Updated

```bash
# After any dependency change
pdm lock --update-reuse
```

---

## Integration with CI/CD

### Pre-commit Checks

The project uses pre-commit hooks to ensure:
- Code formatting (black)
- Linting (flake8)
- Type checking (pyright)

To run manually:
```bash
pre-commit run --all-files
```

### CI Pipeline

The CI pipeline should:
1. Install from `pdm.lock` for reproducibility
2. Run tests with exact versions
3. Build Docker with `requirements.txt`
4. Verify both installations work

---

## Migration from requirements.txt Only

If you have an old project using only `requirements.txt`:

```bash
# 1. Initialize PDM
pdm init

# 2. Import from requirements.txt
pdm import rootfs/webapp/requirements.txt

# 3. Install
pdm install

# 4. Sync going forward
./sync-python-deps.sh
```

---

## FAQ

**Q: Why two files?**  
A: PDM uses `pyproject.toml` for development, but Docker and many tools expect `requirements.txt`.

**Q: Which file should I edit?**  
A: Always edit `pyproject.toml`, then run `./sync-python-deps.sh`.

**Q: Can I edit requirements.txt directly?**  
A: No, it will be overwritten by the sync script. Edit `pyproject.toml` instead.

**Q: What if sync script fails?**  
A: Check the error message. Usually it's a git dependency issue or PDM export failure.

**Q: How do I update just one package?**  
A: `pdm update package-name` then `./sync-python-deps.sh`

**Q: Should I commit pdm.lock?**  
A: Yes, always commit `pdm.lock` for reproducible builds.

**Q: What about dev dependencies?**  
A: Dev dependencies (testing, linting) go in `pyproject.toml` under `[tool.pdm.dev-dependencies]` and are NOT exported to `requirements.txt`.

---

## Related Commands

```bash
# Node.js dependency updates
just update      # Interactive update for Node packages
just bump        # Install Node packages

# Python dependency updates  
just update-py   # Update and sync Python packages
just bump-py     # Install Python packages

# Update everything
just update-all  # Node + Python in one command
```

---

## References

- [PDM Documentation](https://pdm.fming.dev/)
- [PEP 621 - pyproject.toml](https://peps.python.org/pep-0621/)
- [pip requirements.txt format](https://pip.pypa.io/en/stable/reference/requirements-file-format/)